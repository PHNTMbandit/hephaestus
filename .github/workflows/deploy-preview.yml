name: Deploy Preview

on: [pull_request]

env:
    NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
    NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
    NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

permissions: write-all

jobs:
    deploy-preview:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Get branch name
              id: branch-name
              uses: tj-actions/branch-names@v9

            - name: Create Neon Branch
              id: create-branch
              uses: neondatabase/create-branch-action@v6.3.0
              with:
                  api_key: ${{ env.NEON_API_KEY }}
                  project_id: ${{ env.NEON_PROJECT_ID }}
                  branch_name: preview/pr-${{ github.event.number }}-${{ steps.branch-name.outputs.current_branch }}

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Use Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run Migrations
              run: pnpm run db:generate && pnpm run db:migrate
              env:
                  DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}

            - name: Install Netlify CLI
              run: pnpm install -g netlify-cli && netlify link --id ${{ env.NETLIFY_SITE_ID }} --auth ${{ env.NETLIFY_AUTH_TOKEN }}

            - name: Deploy Preview to Netlify with CLI
              id: deploy
              run: |
                  # Pull down the environment variables for the deploy-preview context
                  netlify env:list --context deploy-preview --plain >> .env
                  # Add the database connection URLs to the .env file
                  echo DATABASE_URL="${{ steps.create-branch.outputs.db_url_with_pooler }}" >> .env
                  # Deploy the preview to Netlify
                  netlify deploy --alias="pr-${{ github.event.number }}" --context=deploy-preview --json > netlify-deploy.json
                  # Get the deploy URL from the netlify-deploy.json file
                  DEPLOY_URL=$(cat netlify-deploy.json | jq -r '.deploy_url')
                  # Export the deploy URL as an output for this step
                  echo "deploy_url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

            - name: Comment on Pull Request
              uses: thollander/actions-comment-pull-request@v2
              with:
                  message: |
                      | Resource | Link |
                      |----------|------|
                      | Netlify Preview ğŸš€ | ${{ steps.deploy.outputs.deploy_url }} |
                      | Neon branch ğŸ˜ | https://console.neon.tech/app/projects/${{ env.NEON_PROJECT_ID }}/branches/${{ steps.create-branch.outputs.branch_id }} |
